<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PerpiMonde Online</title>
  <style>
    :root {
      --bg: #0f1221;
      --panel: rgba(16, 20, 36, 0.9);
      --panel-soft: rgba(26, 33, 61, 0.75);
      --accent: #65d9ff;
      --accent-2: #8cff90;
      --danger: #ff6b7c;
      --text: #f2f5ff;
      --muted: #a7b3d1;
      --grid: rgba(255, 255, 255, 0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 10% 10%, #1c2550, var(--bg) 65%);
      min-height: 100vh;
      padding: 14px;
    }

    h1,
    h2,
    h3,
    p {
      margin: 0;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(220px, 300px) minmax(320px, 1fr) minmax(260px, 360px);
      gap: 14px;
      max-width: 1450px;
      margin: 0 auto;
    }

    .panel {
      background: var(--panel);
      border: 1px solid rgba(123, 171, 255, 0.25);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px);
    }

    .header {
      margin-bottom: 12px;
    }

    .subtitle {
      color: var(--muted);
      margin-top: 4px;
      font-size: 0.95rem;
      line-height: 1.35;
    }

    .stat-grid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .stat {
      background: var(--panel-soft);
      border: 1px solid rgba(131, 169, 255, 0.2);
      border-radius: 10px;
      padding: 10px;
      font-size: 0.9rem;
    }

    .stat b {
      display: block;
      color: var(--accent);
      margin-bottom: 3px;
      font-size: 0.8rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .objectives {
      margin-top: 14px;
      list-style: none;
      padding: 0;
      display: grid;
      gap: 8px;
    }

    .objective {
      background: rgba(45, 57, 102, 0.5);
      border-radius: 8px;
      padding: 8px;
      border-left: 4px solid var(--accent);
      font-size: 0.88rem;
    }

    .objective.done {
      border-left-color: var(--accent-2);
      color: #d5ffe2;
      text-decoration: line-through;
      opacity: 0.8;
    }

    .legend {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(2, minmax(90px, 1fr));
      gap: 6px;
      font-size: 0.82rem;
      color: var(--muted);
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .map-wrap {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(14, minmax(24px, 1fr));
      gap: 2px;
      background: rgba(3, 7, 22, 0.85);
      border-radius: 12px;
      padding: 8px;
      border: 1px solid rgba(102, 151, 255, 0.3);
    }

    .tile {
      aspect-ratio: 1;
      border-radius: 5px;
      border: 1px solid var(--grid);
      display: grid;
      place-items: center;
      font-size: 0.92rem;
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .tile::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
    }

    .road { background: #6d768f; }
    .grass { background: #337c4d; }
    .water { background: #2d5ca4; }
    .market { background: #9e7753; }
    .castle { background: #8a6fcf; }
    .station { background: #8c4f5f; }
    .beach { background: #c9be71; }

    .player,
    .npc,
    .other {
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.65);
      z-index: 2;
      position: relative;
    }

    .other { opacity: 0.85; }

    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.86rem;
      color: var(--muted);
    }

    .controls {
      margin-top: 8px;
      display: grid;
      gap: 8px;
      justify-items: center;
      align-items: center;
    }

    .controls-row {
      display: flex;
      gap: 8px;
    }

    .control-btn {
      min-width: 46px;
      min-height: 42px;
      padding: 0;
      font-size: 1rem;
      line-height: 1;
    }

    .kbd {
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-bottom-width: 2px;
      border-radius: 5px;
      padding: 2px 6px;
      color: #fff;
    }

    .battle,
    .chat,
    .log {
      margin-top: 12px;
      background: rgba(18, 26, 51, 0.8);
      border: 1px solid rgba(114, 163, 255, 0.25);
      border-radius: 10px;
      padding: 10px;
    }

    .battle h3,
    .chat h3,
    .log h3 {
      margin-bottom: 8px;
      font-size: 0.96rem;
      color: var(--accent);
    }

    .monster-card {
      display: grid;
      gap: 3px;
      background: rgba(45, 59, 102, 0.5);
      border-radius: 8px;
      padding: 8px;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .hp-track {
      height: 8px;
      border-radius: 100px;
      background: rgba(255, 255, 255, 0.15);
      overflow: hidden;
    }

    .hp-track > div {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #7dff8f, #54d5ff);
      transition: width 0.25s ease;
    }

    button {
      border: none;
      background: linear-gradient(135deg, #4ea5ff, #6655ff);
      color: white;
      font-weight: 700;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.84rem;
    }

    button.secondary {
      background: #394568;
    }

    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .battle-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    #news,
    #chatFeed,
    #eventLog {
      max-height: 170px;
      overflow: auto;
      display: grid;
      gap: 6px;
      font-size: 0.84rem;
    }

    .line {
      background: rgba(45, 58, 101, 0.6);
      border-radius: 6px;
      padding: 6px;
      border-left: 3px solid rgba(135, 178, 255, 0.65);
    }

    .small {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .chat-form {
      margin-top: 8px;
      display: flex;
      gap: 6px;
    }

    .chat-form input {
      flex: 1;
      border-radius: 7px;
      border: 1px solid rgba(125, 165, 255, 0.4);
      background: rgba(9, 15, 31, 0.85);
      color: #fff;
      padding: 8px;
    }

    @media (max-width: 1150px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="layout">
    <section class="panel">
      <div class="header">
        <h1>PerpiMonde Online</h1>
        <p class="subtitle">
          Prototype MMO-RPG inspir√© des jeux de capture, situ√© √† Perpignan (Castillet, gare, march√©, plage de Canet).
        </p>
      </div>

      <div class="stat-grid">
        <div class="stat"><b>Dresseur</b><span id="trainerName">Rookie66</span></div>
        <div class="stat"><b>Niveau</b><span id="trainerLevel">1</span></div>
        <div class="stat"><b>EXP</b><span id="trainerExp">0 / 100</span></div>
        <div class="stat"><b>Pi√®ces</b><span id="trainerCoins">80</span></div>
      </div>

      <ul id="objectives" class="objectives"></ul>

      <div class="legend">
        <span><i class="dot" style="background:#8a6fcf"></i>Castillet</span>
        <span><i class="dot" style="background:#9e7753"></i>March√©</span>
        <span><i class="dot" style="background:#2d5ca4"></i>T√™t</span>
        <span><i class="dot" style="background:#c9be71"></i>Canet</span>
      </div>

      <div class="log">
        <h3>Fil d'actualit√©s de PerpiMonde</h3>
        <div id="news"></div>
      </div>
    </section>

    <section class="panel map-wrap">
      <div class="toolbar">
        D√©placement: <span class="kbd">‚Üë</span><span class="kbd">‚Üì</span><span class="kbd">‚Üê</span><span class="kbd">‚Üí</span>
        ¬∑ Action: <span class="kbd">Espace</span>
      </div>
      <div class="controls">
        <div class="controls-row">
          <button id="moveUp" class="control-btn" title="Aller vers le nord">‚Üë</button>
        </div>
        <div class="controls-row">
          <button id="moveLeft" class="control-btn" title="Aller vers l'ouest">‚Üê</button>
          <button id="spawnBtn" class="control-btn secondary" title="Forcer une rencontre">‚ö°</button>
          <button id="moveRight" class="control-btn" title="Aller vers l'est">‚Üí</button>
        </div>
        <div class="controls-row">
          <button id="moveDown" class="control-btn" title="Aller vers le sud">‚Üì</button>
        </div>
      </div>
      <div id="board" class="board"></div>
      <p class="small" id="zoneText">Zone actuelle: Quartier Saint-Jean</p>
      <p class="small">Astuce: tu peux jouer au clavier ou avec les boutons juste au-dessus de la carte.</p>
    </section>

    <section class="panel">
      <div class="battle">
        <h3>Rencontre sauvage</h3>
        <div id="enemySlot" class="monster-card">Aucune rencontre pour le moment.</div>
        <div id="allySlot" class="monster-card"></div>
        <div class="battle-buttons">
          <button id="attackBtn" disabled>Attaque locale</button>
          <button id="captureBtn" disabled>Capture catalane</button>
          <button id="escapeBtn" class="secondary" disabled>Fuir</button>
        </div>
      </div>

      <div class="chat">
        <h3>Canal Monde (m√™me navigateur)</h3>
        <div id="chatFeed"></div>
        <form id="chatForm" class="chat-form">
          <input id="chatInput" maxlength="110" placeholder="Parle aux autres dresseurs..." />
          <button>Envoyer</button>
        </form>
      </div>

      <div class="log">
        <h3>Journal d'√©v√©nements</h3>
        <div id="eventLog"></div>
      </div>
    </section>
  </main>

  <script>
    const width = 14;
    const height = 10;
    const board = document.getElementById("board");

    const terrain = [
      "rrrrrrrggggggg",
      "rccccrrggggggg",
      "rcrrrrggggwwww",
      "rcrmmrgggwwwww",
      "rrrmmrrrrwwwbb",
      "gggrrrrsrrrbbb",
      "gggggsssssrrbb",
      "gggggggrrrrrrb",
      "gggggggrrrrrrb",
      "gggggggrrrrrrb"
    ];

    const tileClass = { r: "road", g: "grass", w: "water", m: "market", c: "castle", s: "station", b: "beach" };
    const zoneName = { r: "Centre-ville", g: "Quartier vert", w: "Berges de la T√™t", m: "March√© place Cassanyes", c: "Castillet", s: "Gare de Perpignan", b: "Plage de Canet" };

    const monsters = [
      { name: "Flamaillon", type: "Feu", maxHp: 28, attack: 8, icon: "ü¶ä" },
      { name: "Mistravolt", type: "√âlectrik", maxHp: 26, attack: 9, icon: "ü¶â" },
      { name: "Tetacool", type: "Eau", maxHp: 30, attack: 7, icon: "üêü" },
      { name: "Catafeuille", type: "Plante", maxHp: 32, attack: 6, icon: "ü¶é" }
    ];

    const wildByTile = {
      g: ["Catafeuille", "Mistravolt"],
      w: ["Tetacool"],
      b: ["Tetacool", "Flamaillon"],
      r: ["Flamaillon"],
      m: ["Mistravolt"],
      c: ["Flamaillon", "Catafeuille"],
      s: ["Mistravolt"]
    };

    const player = {
      name: "Rookie66",
      x: 2,
      y: 2,
      level: 1,
      exp: 0,
      expCap: 100,
      coins: 80,
      monsters: [
        { name: "Roussi", type: "Feu", hp: 34, maxHp: 34, attack: 8, icon: "ü¶ä" }
      ],
      objectives: [
        { id: "castillet", text: "Atteindre le Castillet", done: false },
        { id: "capture", text: "Capturer un monstre sauvage", done: false },
        { id: "canet", text: "Explorer la plage de Canet", done: false }
      ]
    };

    let enemy = null;
    let lastEncounterStep = 0;
    let stepCount = 0;

    const newsFeed = document.getElementById("news");
    const eventLog = document.getElementById("eventLog");
    const zoneText = document.getElementById("zoneText");
    const objectivesEl = document.getElementById("objectives");
    const enemySlot = document.getElementById("enemySlot");
    const allySlot = document.getElementById("allySlot");

    const attackBtn = document.getElementById("attackBtn");
    const captureBtn = document.getElementById("captureBtn");
    const escapeBtn = document.getElementById("escapeBtn");

    const trainerName = document.getElementById("trainerName");
    const trainerLevel = document.getElementById("trainerLevel");
    const trainerExp = document.getElementById("trainerExp");
    const trainerCoins = document.getElementById("trainerCoins");

    const chatFeed = document.getElementById("chatFeed");
    const chatForm = document.getElementById("chatForm");
    const chatInput = document.getElementById("chatInput");

    const channel = "BroadcastChannel" in window ? new BroadcastChannel("perpimonde-chat") : null;
    const moveUpBtn = document.getElementById("moveUp");
    const moveDownBtn = document.getElementById("moveDown");
    const moveLeftBtn = document.getElementById("moveLeft");
    const moveRightBtn = document.getElementById("moveRight");
    const spawnBtn = document.getElementById("spawnBtn");

    function rand(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function log(container, message) {
      const line = document.createElement("div");
      line.className = "line";
      line.textContent = message;
      container.prepend(line);
      while (container.children.length > 7) container.removeChild(container.lastChild);
    }

    function renderStats() {
      trainerName.textContent = player.name;
      trainerLevel.textContent = player.level;
      trainerExp.textContent = `${player.exp} / ${player.expCap}`;
      trainerCoins.textContent = player.coins;
    }

    function renderObjectives() {
      objectivesEl.innerHTML = "";
      player.objectives.forEach((obj) => {
        const li = document.createElement("li");
        li.className = `objective ${obj.done ? "done" : ""}`;
        li.textContent = obj.text;
        objectivesEl.appendChild(li);
      });
    }

    function completeObjective(id) {
      const objective = player.objectives.find((o) => o.id === id);
      if (!objective || objective.done) return;
      objective.done = true;
      player.coins += 35;
      addExp(25);
      log(eventLog, `Qu√™te valid√©e: ${objective.text} (+35 pi√®ces, +25 EXP)`);
      renderObjectives();
      renderStats();
    }

    function addExp(amount) {
      player.exp += amount;
      while (player.exp >= player.expCap) {
        player.exp -= player.expCap;
        player.level += 1;
        player.expCap += 45;
        player.monsters[0].maxHp += 4;
        player.monsters[0].hp = player.monsters[0].maxHp;
        player.monsters[0].attack += 1;
        log(newsFeed, `‚≠ê ${player.name} passe niveau ${player.level} en explorant Perpignan.`);
      }
    }

    function drawBoard() {
      board.innerHTML = "";
      const others = getGhostPlayers();

      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const tile = document.createElement("div");
          const code = terrain[y][x];
          tile.className = `tile ${tileClass[code]}`;

          if (x === player.x && y === player.y) {
            const unit = document.createElement("span");
            unit.className = "player";
            unit.textContent = "üßë";
            tile.appendChild(unit);
          }

          const ghost = others.find((o) => o.x === x && o.y === y);
          if (ghost) {
            const mark = document.createElement("span");
            mark.className = "other";
            mark.textContent = "üë§";
            mark.title = ghost.name;
            tile.appendChild(mark);
          }

          if (code === "c" && x === 1 && y === 1) tile.title = "Le Castillet";
          if (code === "m" && x === 3 && y === 3) tile.title = "March√© de Cassanyes";
          if (code === "s" && x === 6 && y === 6) tile.title = "Gare de Perpignan";
          if (code === "b" && x === 13 && y === 8) tile.title = "Canet-plage";

          board.appendChild(tile);
        }
      }

      const currentCode = terrain[player.y][player.x];
      zoneText.textContent = `Zone actuelle: ${zoneName[currentCode]}`;
      if (currentCode === "c") completeObjective("castillet");
      if (currentCode === "b") completeObjective("canet");
      publishPresence();
    }

    function getGhostPlayers() {
      try {
        const raw = JSON.parse(localStorage.getItem("perpimonde-presence") || "[]");
        const now = Date.now();
        return raw.filter((p) => now - p.updatedAt < 16000 && p.id !== sessionId);
      } catch {
        return [];
      }
    }

    const sessionId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;

    function publishPresence() {
      const mine = {
        id: sessionId,
        name: player.name,
        x: player.x,
        y: player.y,
        updatedAt: Date.now()
      };

      const alive = getGhostPlayers();
      alive.push(mine);
      localStorage.setItem("perpimonde-presence", JSON.stringify(alive));
    }

    function spawnEnemy() {
      const tile = terrain[player.y][player.x];
      const pool = wildByTile[tile] || [];
      if (!pool.length) return;

      const name = pool[rand(0, pool.length - 1)];
      const template = monsters.find((m) => m.name === name);
      enemy = {
        ...template,
        hp: template.maxHp + rand(0, player.level * 2),
        maxHp: template.maxHp + rand(0, player.level * 2),
        attack: template.attack + rand(0, Math.max(1, player.level - 1))
      };

      renderBattle();
      log(eventLog, `Un ${enemy.name} sauvage appara√Æt dans ${zoneName[tile]}!`);
      attackBtn.disabled = false;
      captureBtn.disabled = false;
      escapeBtn.disabled = false;
    }

    function renderBattle() {
      const ally = player.monsters[0];
      allySlot.innerHTML = `
        <strong>${ally.icon} ${ally.name}</strong>
        <span>Type: ${ally.type}</span>
        <span>PV: ${ally.hp}/${ally.maxHp}</span>
        <div class="hp-track"><div style="width:${(ally.hp / ally.maxHp) * 100}%"></div></div>
      `;

      if (!enemy) {
        enemySlot.textContent = "Aucune rencontre pour le moment.";
        attackBtn.disabled = true;
        captureBtn.disabled = true;
        escapeBtn.disabled = true;
        return;
      }

      enemySlot.innerHTML = `
        <strong>${enemy.icon} ${enemy.name}</strong>
        <span>Type: ${enemy.type}</span>
        <span>PV: ${enemy.hp}/${enemy.maxHp}</span>
        <div class="hp-track"><div style="width:${(enemy.hp / enemy.maxHp) * 100}%"></div></div>
      `;
    }

    function resolveEnemyTurn() {
      if (!enemy) return;
      const ally = player.monsters[0];
      const dmg = rand(Math.max(1, enemy.attack - 3), enemy.attack + 1);
      ally.hp = Math.max(0, ally.hp - dmg);
      log(eventLog, `${enemy.name} inflige ${dmg} d√©g√¢ts √† ${ally.name}.`);

      if (ally.hp <= 0) {
        ally.hp = Math.floor(ally.maxHp * 0.4);
        player.coins = Math.max(0, player.coins - 15);
        log(newsFeed, `üí• ${player.name} est renvoy√© au centre Pok√©mon de la gare (-15 pi√®ces).`);
        enemy = null;
      }

      renderBattle();
      renderStats();
    }

    attackBtn.addEventListener("click", () => {
      if (!enemy) return;
      const ally = player.monsters[0];
      const dmg = rand(ally.attack - 2, ally.attack + 4);
      enemy.hp = Math.max(0, enemy.hp - dmg);
      log(eventLog, `${ally.name} attaque et retire ${dmg} PV √† ${enemy.name}.`);

      if (enemy.hp <= 0) {
        const gain = rand(20, 34);
        player.coins += rand(8, 16);
        addExp(gain);
        log(newsFeed, `üèÜ ${player.name} a battu ${enemy.name} (+${gain} EXP).`);
        enemy = null;
        renderStats();
        renderBattle();
        return;
      }

      renderBattle();
      resolveEnemyTurn();
    });

    captureBtn.addEventListener("click", () => {
      if (!enemy) return;
      const chance = 0.2 + (1 - enemy.hp / enemy.maxHp) * 0.55;
      if (Math.random() < chance) {
        player.monsters.push({
          name: enemy.name,
          type: enemy.type,
          hp: enemy.maxHp,
          maxHp: enemy.maxHp,
          attack: enemy.attack,
          icon: enemy.icon
        });
        completeObjective("capture");
        log(newsFeed, `üéØ ${player.name} capture ${enemy.name} pr√®s de ${zoneName[terrain[player.y][player.x]]}.`);
        enemy = null;
      } else {
        log(eventLog, `La capture √©choue! ${enemy.name} se d√©bat.`);
        resolveEnemyTurn();
      }
      renderBattle();
    });

    escapeBtn.addEventListener("click", () => {
      if (!enemy) return;
      enemy = null;
      log(eventLog, "Tu prends la fuite vers une rue adjacente.");
      renderBattle();
    });

    function move(dx, dy) {
      const nx = Math.max(0, Math.min(width - 1, player.x + dx));
      const ny = Math.max(0, Math.min(height - 1, player.y + dy));
      if (nx === player.x && ny === player.y) return;

      player.x = nx;
      player.y = ny;
      stepCount++;
      drawBoard();

      if (enemy) return;
      const tile = terrain[player.y][player.x];
      if ((tile === "g" || tile === "b" || tile === "w" || tile === "m" || tile === "r") && stepCount - lastEncounterStep >= 2 && Math.random() < 0.35) {
        lastEncounterStep = stepCount;
        spawnEnemy();
      }
    }

    document.addEventListener("keydown", (event) => {
      if (event.key === "ArrowUp") move(0, -1);
      if (event.key === "ArrowDown") move(0, 1);
      if (event.key === "ArrowLeft") move(-1, 0);
      if (event.key === "ArrowRight") move(1, 0);
      if (event.key === " " && !enemy) spawnEnemy();
    });

    moveUpBtn.addEventListener("click", () => move(0, -1));
    moveDownBtn.addEventListener("click", () => move(0, 1));
    moveLeftBtn.addEventListener("click", () => move(-1, 0));
    moveRightBtn.addEventListener("click", () => move(1, 0));
    spawnBtn.addEventListener("click", () => {
      if (!enemy) spawnEnemy();
    });

    function addChatMessage(msg) {
      const line = document.createElement("div");
      line.className = "line";
      line.textContent = `[${msg.time}] ${msg.author}: ${msg.text}`;
      chatFeed.prepend(line);
      while (chatFeed.children.length > 8) chatFeed.removeChild(chatFeed.lastChild);
    }

    chatForm.addEventListener("submit", (event) => {
      event.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;
      const payload = {
        author: player.name,
        text,
        time: new Date().toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" })
      };
      addChatMessage(payload);
      if (channel) channel.postMessage(payload);
      chatInput.value = "";
    });

    if (channel) {
      channel.onmessage = (event) => addChatMessage(event.data);
    }

    log(newsFeed, "Bienvenue dans PerpiMonde: le MMORPG de capture catalan.");
    log(newsFeed, "√âv√®nement: tournoi amateur ce soir devant le Castillet.");
    renderStats();
    renderObjectives();
    renderBattle();
    drawBoard();

    window.addEventListener("beforeunload", () => {
      const alive = getGhostPlayers();
      localStorage.setItem("perpimonde-presence", JSON.stringify(alive));
      if (channel) channel.close();
    });

    setInterval(drawBoard, 5000);
  </script>
</body>
</html>
